



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for the Citrix Ingress Controller for Kubernetes">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="/media/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Deploy HTTPs web application on K8s with CIC and HashiCorp vault using cert-manager - Citrix Ingress Controller for Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#deploying-https-web-application-on-kubernetes-with-citrix-ingress-controller-and-hashicorp-vault-using-cert-manager" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <div class="md-header-border-top"/>
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Citrix Ingress Controller for Kubernetes" class="md-header-nav__button md-logo">
          
            <img src="https://developer-docs.citrix.com/_static/Citrix_Logo_Black.png" width="75px" height="28.275px">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Developer Docs
            </span>
            <span class="md-header-nav__topic">
              Deploy HTTPs web application on K8s with CIC and HashiCorp vault using cert-manager
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/citrix/citrix-k8s-ingress-controller-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Citrix Ingress Controller
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Citrix Ingress Controller for Kubernetes" class="md-nav__button md-logo">
      
        <img src="https://developer-docs.citrix.com/_static/Citrix_Logo_Black.png" width="48" height="48">
      
    </a>
    Citrix Ingress Controller for Kubernetes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/citrix/citrix-k8s-ingress-controller-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Citrix Ingress Controller
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../deployment-topologies/" title="Deployment topologies" class="md-nav__link">
      Deployment topologies
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Deploy Citrix Ingress Controller
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Deploy Citrix Ingress Controller
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy-cic-yaml/" title="Using YAML" class="md-nav__link">
      Using YAML
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy-cic-helm/" title="Using Helm charts" class="md-nav__link">
      Using Helm charts
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Deployment solutions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Deployment solutions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy-azure/" title="Deploy Citrix ADC CPX as an Ingress in Azure Kubernetes Engine" class="md-nav__link">
      Deploy Citrix ADC CPX as an Ingress in Azure Kubernetes Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy-gcp/" title="Deploy Citrix ADC CPX as an Ingress in Google Cloud Platform" class="md-nav__link">
      Deploy Citrix ADC CPX as an Ingress in Google Cloud Platform
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../licensing/" title="Licensing" class="md-nav__link">
      Licensing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Configure
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Configure
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configure/annotations/" title="Annotations" class="md-nav__link">
      Annotations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configure/ingress-classes/" title="Ingress class" class="md-nav__link">
      Ingress class
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configure/logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Network
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Network
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../network/staticrouting/" title="Static routing" class="md-nav__link">
      Static routing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      CRDs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        CRDs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../crds/rewrite-responder/" title="Using Rewrite and Responder policies in Kubernetes" class="md-nav__link">
      Using Rewrite and Responder policies in Kubernetes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9" checked>
    
    <label class="md-nav__link" for="nav-9">
      Certificate management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Certificate management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tls-certificate-handling-multiple-ingress/" title="TLS certificate handling for multiple Ingress" class="md-nav__link">
      TLS certificate handling for multiple Ingress
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tls-certificate-handling/" title="TLS certificates in Citrix Ingress Controller" class="md-nav__link">
      TLS certificates in Citrix Ingress Controller
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-3" type="checkbox" id="nav-9-3" checked>
    
    <label class="md-nav__link" for="nav-9-3">
      Automated certificate management with cert-manager
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-9-3">
        Automated certificate management with cert-manager
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../certificate/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../acme/" title="Deploy HTTPs web applications on K8s with CIC and Let’s Encrypt using cert-manager" class="md-nav__link">
      Deploy HTTPs web applications on K8s with CIC and Let’s Encrypt using cert-manager
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Deploy HTTPs web application on K8s with CIC and HashiCorp vault using cert-manager
      </label>
    
    <a href="./" title="Deploy HTTPs web application on K8s with CIC and HashiCorp vault using cert-manager" class="md-nav__link md-nav__link--active">
      Deploy HTTPs web application on K8s with CIC and HashiCorp vault using cert-manager
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-cert-manager-using-the-manifest-file" title="Deploy cert-manager using the manifest file" class="md-nav__link">
    Deploy cert-manager using the manifest file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-a-sample-web-application" title="Deploy a sample web application" class="md-nav__link">
    Deploy a sample web application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-hashicorp-vault-as-certificate-authority" title="Configure Hashicorp Vault as Certificate Authority" class="md-nav__link">
    Configure Hashicorp Vault as Certificate Authority
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-root-ca" title="Create a root CA" class="md-nav__link">
    Create a root CA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-an-intermediate-ca" title="Generate an intermediate CA" class="md-nav__link">
    Generate an intermediate CA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-a-role" title="Configure a role" class="md-nav__link">
    Configure a role
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-approle-based-authentication" title="Create Approle based authentication" class="md-nav__link">
    Create Approle based authentication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-an-approle" title="Create an Approle" class="md-nav__link">
    Create an Approle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associate-a-policy-with-the-approle" title="Associate a policy with the Approle" class="md-nav__link">
    Associate a policy with the Approle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-role-id-and-secret-id" title="Generate the Role id and Secret id" class="md-nav__link">
    Generate the Role id and Secret id
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-issuing-certificates-in-kubernetes" title="Configure issuing certificates in Kubernetes" class="md-nav__link">
    Configure issuing certificates in Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-secret-with-approle-secret-id" title="Create a secret with Approle secret-id" class="md-nav__link">
    Create a secret with Approle secret-id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-vault-cluster-issuer" title="Deploy the Vault cluster issuer" class="md-nav__link">
    Deploy the Vault cluster issuer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-certificate-crd-object-for-the-certificate" title="Create a "certificate" CRD object for the certificate" class="md-nav__link">
    Create a "certificate" CRD object for the certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-if-the-certificate-is-issued" title="Verify if the certificate is issued" class="md-nav__link">
    Verify if the certificate is issued
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-the-ingress-to-use-the-generated-secret" title="Modify the ingress to use the generated secret" class="md-nav__link">
    Modify the ingress to use the generated secret
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Metrics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Metrics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../metrics/promotheus-grafana/" title="Integrate with Promotheus and Grafana" class="md-nav__link">
      Integrate with Promotheus and Grafana
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../upgrade/" title="Upgrade" class="md-nav__link">
      Upgrade
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-cert-manager-using-the-manifest-file" title="Deploy cert-manager using the manifest file" class="md-nav__link">
    Deploy cert-manager using the manifest file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-a-sample-web-application" title="Deploy a sample web application" class="md-nav__link">
    Deploy a sample web application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-hashicorp-vault-as-certificate-authority" title="Configure Hashicorp Vault as Certificate Authority" class="md-nav__link">
    Configure Hashicorp Vault as Certificate Authority
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-root-ca" title="Create a root CA" class="md-nav__link">
    Create a root CA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-an-intermediate-ca" title="Generate an intermediate CA" class="md-nav__link">
    Generate an intermediate CA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-a-role" title="Configure a role" class="md-nav__link">
    Configure a role
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-approle-based-authentication" title="Create Approle based authentication" class="md-nav__link">
    Create Approle based authentication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-an-approle" title="Create an Approle" class="md-nav__link">
    Create an Approle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associate-a-policy-with-the-approle" title="Associate a policy with the Approle" class="md-nav__link">
    Associate a policy with the Approle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-role-id-and-secret-id" title="Generate the Role id and Secret id" class="md-nav__link">
    Generate the Role id and Secret id
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-issuing-certificates-in-kubernetes" title="Configure issuing certificates in Kubernetes" class="md-nav__link">
    Configure issuing certificates in Kubernetes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-secret-with-approle-secret-id" title="Create a secret with Approle secret-id" class="md-nav__link">
    Create a secret with Approle secret-id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-vault-cluster-issuer" title="Deploy the Vault cluster issuer" class="md-nav__link">
    Deploy the Vault cluster issuer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-certificate-crd-object-for-the-certificate" title="Create a "certificate" CRD object for the certificate" class="md-nav__link">
    Create a "certificate" CRD object for the certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-if-the-certificate-is-issued" title="Verify if the certificate is issued" class="md-nav__link">
    Verify if the certificate is issued
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modify-the-ingress-to-use-the-generated-secret" title="Modify the ingress to use the generated secret" class="md-nav__link">
    Modify the ingress to use the generated secret
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/citrix/citrix-k8s-ingress-controller-docs/edit/master/docs/certificate-management/vault.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="deploying-https-web-application-on-kubernetes-with-citrix-ingress-controller-and-hashicorp-vault-using-cert-manager">Deploying HTTPS web application on Kubernetes with Citrix Ingress Controller and Hashicorp Vault using cert-manager</h1>
<p>This topic provides a sample workflow that uses HashiCorp Vault as self-signed CA to automate TLS certificate provisioning, revocation, and renewal for ingress resources deployed with Citrix ingress controller using cert-manager.</p>
<p>Specifically, the workflow uses the Vault PKI Secrets Engine to create a CA. This tutorial assumes that you have a Vault server installed and reachable from the Kubernetes cluster. The PKI secrets engine of Vault is suitable for internal applications and for external facing applications that require public trust, you can refer <a href="../acme/">automating TLS certificates using letsencrypt CA</a></p>
<p>The workflow uses a Vault secret engine and authentication methods, refer the following Vault documentation for full list of features:</p>
<ul>
<li>
<p><a href="https://www.vaultproject.io/docs/secrets/index.html">Vault Secrets Engines</a></p>
</li>
<li>
<p><a href="https://www.vaultproject.io/docs/auth/index.html">Vault Authentication Methods</a></p>
</li>
</ul>
<p>This topic provides you information on how to deploy an HTTPS web application on a Kubernetes cluster, using:</p>
<ul>
<li>Citrix ingress controller (CIC)</li>
<li>JetStack's <a href="https://github.com/jetstack/cert-manager">cert-manager</a> to provision TLS certificates from <a href="https://www.vaultproject.io/">Hashicorp Vault</a></li>
<li><a href="https://www.vaultproject.io/">Hashicorp Vault</a></li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<p>Ensure that you have:</p>
<ul>
<li>
<p>The Vault server is installed, unsealed and is reachable from Kubernetes cluster.</p>
</li>
<li>
<p>Enabled RBAC on your Kubernetes cluster.</p>
</li>
<li>
<p>Deployed Citrix ADC MPX, VPX or CPX in Tier 1 or Tier 2 deployment model.</p>
<p>In the Tier 1 deployment model, Citrix ADC MPX or VPX is used as an Application Delivery Controller (ADC) and Citrix Ingress Controller (CIC) running in Kubernetes cluster configures the virtual services for the services running on Kubernetes cluster. Citrix ADC runs the virtual service on the publicly routable IP address and offloads SSL for client traffic with the help of Let's Encrypt generated certificate.</p>
<p>Similarly in the Tier 2 deployment model, a TCP service is configured on the Citrix ADC (VPX/MPX) running outside the Kubernetes cluster to forward the traffic to Citrix ADC CPX instances running in the Kubernetes cluster. Citrix ADC CPX ends the SSL session and load-balances the traffic to actual service pods.</p>
</li>
<li>
<p>Deployed Citrix ingress controller. Click <a href="../../deployment-topologies/">here</a> for various deployment scenarios.</p>
</li>
<li>
<p>Administrator permissions for all the deployment steps. If you encounter failures due to permissions, make sure you have administrator permission.</p>
</li>
</ul>
<h2 id="deploy-cert-manager-using-the-manifest-file">Deploy cert-manager using the manifest file</h2>
<p>Perform the following steps to deploy cert-manager using the supplied YAML manifest file.
To keep things simple, skip cert-manager's Helm installation, and instead use the supplied YAML manifests.</p>
<ol>
<li>
<p>Download the latest source of cert-manager from  <code>github.com/jetstack/cert-manager</code> repository using the following command.</p>
<pre class="codehilite"><code>wget https://github.com/jetstack/cert-manager/archive/v0.6.2.tar.gz
tar -zxvf v0.6.2.tar.gz</code></pre>


</li>
<li>
<p>Deploy the cert-manager using the following command.</p>
<pre class="codehilite"><code>kubectl apply -f deploy/manifests/cert-manager.yaml</code></pre>


<p>You can also install the cert-manager with Helm, for more information see <a href="https://github.com/helm/charts/tree/master/stable/cert-manager">cert-manager documentation</a></p>
</li>
<li>
<p>Verify that the cert-manager is up and running using the following command.</p>
<pre class="codehilite"><code>% kubectl -n cert-manager get all
NAME                                       READY   STATUS    RESTARTS   AGE
pod/cert-manager-77fd74fb64-d68v7          1/1     Running   0          4m41s
pod/cert-manager-webhook-67bf86d45-k77jj   1/1     Running   0          4m41s

NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/cert-manager-webhook   ClusterIP   10.108.161.154   &lt;none&gt;        443/TCP   13d

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cert-manager           1/1     1            1           13d
deployment.apps/cert-manager-webhook   1/1     1            1           13d

NAME                                             DESIRED   CURRENT   READY   AGE
replicaset.apps/cert-manager-77fd74fb64          1         1         1       13d
replicaset.apps/cert-manager-webhook-67bf86d45   1         1         1       13d

NAME                                                COMPLETIONS   DURATION   AGE
job.batch/cert-manager-webhook-ca-sync              1/1           22s        13d
job.batch/cert-manager-webhook-ca-sync-1549756800   1/1           21s        10d
job.batch/cert-manager-webhook-ca-sync-1550361600   1/1           19s        3d8h

NAME                                         SCHEDULE   SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob.batch/cert-manager-webhook-ca-sync   @weekly    False     0        3d8h            13d</code></pre>


</li>
</ol>
<h2 id="deploy-a-sample-web-application">Deploy a sample web application</h2>
<p>Perform the following steps to deploy a sample web application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="https://github.com/kubernetes-up-and-running/kuard">Kuard</a>, a kubernetes demo application is used for reference in this topic.</p>
</div>
<ol>
<li>
<p>Create a deployment YAML file (<code>kuard-deployment.yaml</code>) for Kuard with the following configuration.</p>
<pre class="codehilite"><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kuard
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: kuard
    spec:
      containers:
      - image: gcr.io/kuar-demo/kuard-amd64:1
        imagePullPolicy: Always
        name: kuard
        ports:
        - containerPort: 8080</code></pre>


</li>
<li>
<p>Deploy Kuard deployment file (<code>kuard-deployment.yaml</code>) to your cluster, using the following commands.</p>
<pre class="codehilite"><code>% kubectl create -f kuard-deployment.yaml
deployment.extensions/kuard created
% kubectl get pod -l app=kuard
NAME                     READY   STATUS    RESTARTS   AGE
kuard-6fc4d89bfb-djljt   1/1     Running   0          24s</code></pre>


</li>
<li>
<p>Create a service for the deployment. Create a file called <code>service.yaml</code> with the following configuration.</p>
<pre class="codehilite"><code>apiVersion: v1
kind: Service
metadata:
  name: kuard
spec:
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  selector:
    app: kuard</code></pre>


</li>
<li>
<p>Deploy and verify the service using the following command.</p>
<pre class="codehilite"><code>% kubectl create -f service.yaml
service/kuard created
% kubectl get svc kuard
NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kuard   ClusterIP   10.103.49.171   &lt;none&gt;        80/TCP    13s</code></pre>


</li>
<li>
<p>Expose this service to outside world by creating an Ingress that is deployed on Citrix ADC CPX or VPX as Content switching virtual server.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that you change <code>kubernetes.io/ingress.class</code> to your ingress class on which CIC is started.</p>
<p>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kuard
  annotations:
    kubernetes.io/ingress.class: "citrix"
spec:
  rules:
  - host: kuard.example.com
    http:
      paths:
      - backend:
          serviceName: kuard
          servicePort: 80</p>
</div>
<div class="admonition info">
<p class="admonition-title">Important</p>
<p>Change the value of <code>spec.rules.host</code> to the domain that you control. Ensure that a DNS entry exists to route the traffic to Citrix ADC CPX or VPX.</p>
</div>
</li>
<li>
<p>Deploy the Ingress using the following command.</p>
<pre class="codehilite"><code>% kubectl apply -f ingress.yml
ingress.extensions/kuard created
root@ubuntu-vivek-225:~/cert-manager# kubectl get ingress
NAME    HOSTS               ADDRESS   PORTS   AGE
kuard   kuard.example.com             80      7s</code></pre>


</li>
<li>
<p>Verify if the ingress is configured on Citrix ADC CPX or VPX using the following command.</p>
<pre class="codehilite"><code>kubectl exec -it cpx-ingress-5b85d7c69d-ngd72 /bin/bash
root@cpx-ingress-5b85d7c69d-ngd72:/# cli_script.sh 'sh cs vs'
exec: sh cs vs
1)  k8s-10.244.1.50:80:http (10.244.1.50:80) - HTTP Type: CONTENT
  State: UP
  Last state change was at Thu Feb 21 09:02:14 2019
  Time since last state change: 0 days, 00:00:41.140
  Client Idle Timeout: 180 sec
  Down state flush: ENABLED
  Disable Primary Vserver On Down : DISABLED
  Comment: uid=75VBGFO7NZXV7SCI4LSDJML2Q5X6FSNK6NXQPWGMDOYGBW2IMOGQ====
  Appflow logging: ENABLED
  Port Rewrite : DISABLED
  State Update: DISABLED
  Default:  Content Precedence: RULE
  Vserver IP and Port insertion: OFF
  L2Conn: OFF   Case Sensitivity: ON
  Authentication: OFF
  401 Based Authentication: OFF
  Push: DISABLED    Push VServer:
  Push Label Rule: none
  Listen Policy: NONE
  IcmpResponse: PASSIVE
  RHIstate:  PASSIVE
  Traffic Domain: 0
Done
root@cpx-ingress-5b85d7c69d-ngd72:/# exit
exit</code></pre>


</li>
<li>
<p>Verify if the page is correctly being served when requested using the <code>curl</code> command.</p>
<pre class="codehilite"><code>% curl -sS -D - kuard.example.com -o /dev/null
HTTP/1.1 200 OK
Content-Length: 1458
Content-Type: text/html
Date: Thu, 21 Feb 2019 09:09:05 GMT</code></pre>


</li>
</ol>
<h2 id="configure-hashicorp-vault-as-certificate-authority">Configure Hashicorp Vault as Certificate Authority</h2>
<p>Set up an intermediate CA certificate signing request using Hashicorp Vault. This Vault endpoint is used by cert-manager to sign the certificate for the ingress resources.</p>
<h3 id="prerequisites_1">Prerequisites</h3>
<p>Ensure that you have installed the <code>jq</code> utility.</p>
<h3 id="create-a-root-ca">Create a root CA</h3>
<p>For the sample workflow you can generate your own Root Certificate Authority within the Vault. In a production environment, you should use an external Root CA to sign the intermediate CA that Vault uses to generate certificates. If you have a root CA generated elsewhere, skip this step. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>PKI_ROOT</code> is a path where you mount the root CA, typically it is 'pki'. ${DOMAIN} in this procedure is <code>example.com</code></p>
</div>
<pre class="codehilite"><code>% vault secrets enable -path=&quot;${PKI_ROOT}&quot; pki

# Set the max TTL for the root CA to 10 years
% vault secrets tune -max-lease-ttl=87600h &quot;${PKI_ROOT}&quot;

% vault write -format=json &quot;${PKI_ROOT}&quot;/root/generate/internal \
 common_name=&quot;${DOMAIN} CA root&quot; ttl=87600h | tee \
&gt;(jq -r .data.certificate &gt; ca.pem) \
&gt;(jq -r .data.issuing_ca &gt; issuing_ca.pem) \
&gt;(jq -r .data.private_key &gt; ca-key.pem)

#Configure the CA and CRL URLs:

% vault write &quot;${PKI_ROOT}&quot;/config/urls \
       issuing_certificates=&quot;${VAULT_ADDR}/v1/${PKI_ROOT}/ca&quot; \
       crl_distribution_points=&quot;${VAULT_ADDR}/v1/${PKI_ROOT}/crl&quot;</code></pre>


<h3 id="generate-an-intermediate-ca">Generate an intermediate CA</h3>
<p>After creating the root CA, perform the following steps to create an intermediate CSR using the root CA.</p>
<ol>
<li>
<p>Enable pki from a different path <code>PKI_INT</code> from root CA, typically <code>pki\_int</code>. Use the following command:</p>
<pre class="codehilite"><code>% vault secrets enable -path=${PKI_INT} pki
Set the max TTL to 3 year

% vault secrets tune -max-lease-ttl=26280h ${PKI_INT}</code></pre>


</li>
<li>
<p>Generate CSR for <code>${DOMAIN}</code> that needs to be signed by the root CA, the key is stored internally to vault. Use the following command:</p>
<pre class="codehilite"><code>% vault write -format=json &quot;${PKI_INT}&quot;/intermediate/generate/internal \
common_name=&quot;${DOMAIN} CA intermediate&quot; ttl=43800h | tee \
&gt;(jq -r .data.csr &gt; pki_int.csr) \
&gt;(jq -r .data.private_key &gt; pki_int.pem)</code></pre>


</li>
<li>
<p>Generate and sign the <code>${DOMAIN}</code> certificate as an intermediate CA using root CA, store it as <code>intermediate.cert.pem</code>. Use the following command:</p>
<pre class="codehilite"><code>% vault write -format=json &quot;${PKI_ROOT}&quot;/root/sign-intermediate csr=@pki_int.csr \
        format=pem_bundle \
        | jq -r '.data.certificate' &gt; intermediate.cert.pem</code></pre>


<p>If you are using an external root CA, skip the above step and sign the CSR manually using root CA.</p>
</li>
<li>
<p>Once the CSR is signed and the root CA returns a certificate, it needs to added back into the Vault using the following command:</p>
<pre class="codehilite"><code>% vault write &quot;${PKI_INT}&quot;/intermediate/set-signed certificate=@intermediate.cert.pem</code></pre>


</li>
<li>
<p>Set the CA and CRL location using the following command.</p>
<pre class="codehilite"><code>vault write &quot;${PKI_INT}&quot;/config/urls issuing_certificates=&quot;${VAULT_ADDR}/v1/${PKI_INT}/ca&quot; crl_distribution_points=&quot;${VAULT_ADDR}/v1/${PKI_INT}/crl&quot;</code></pre>


</li>
</ol>
<p>An intermediate CA is setup and can be used to sign certificates for ingress resources.</p>
<h3 id="configure-a-role">Configure a role</h3>
<p>A role is a logical name which maps to policies, administrator can control the certificate generation through the roles.</p>
<p>Create a role for the intermediate CA that provides a set of policies for issuing or signing the certificates using this CA.</p>
<p>There are many configurations that can be configured when creating roles, for more information see, <a href="https://www.vaultproject.io/api/secret/pki/index.html#create-update-role">Vault role documentation</a>.</p>
<p>For the workflow, create a role "<strong><em>kube-ingress</em></strong>" that allows you to sign certificates of <code>${DOMAIN}</code> and its subdomains with a TTL of 90 days.</p>
<pre class="codehilite"><code># with a Max TTL of 90 days
vault write ${PKI_INT}/roles/kube-ingress \
          allowed_domains=${DOMAIN} \
          allow_subdomains=true \
          max_ttl=&quot;2160h&quot;</code></pre>


<h2 id="create-approle-based-authentication">Create Approle based authentication</h2>
<p>After configuring an intermediate CA to sign the certificates, you need to provide an authentication mechanism for cert-manager to use the vault for signing the certificates. Cert-manager supports Approle authentication method which provides a way for the applications to access the Vault defined roles.</p>
<p>An "<strong><em>AppRole</em></strong>" represents a set of Vault policies and login constraints that must be met to receive a token with those policies. For detailed understanding of this authentication method, see <a href="https://www.vaultproject.io/docs/auth/approle.html">Approle documentation</a>.</p>
<h3 id="create-an-approle">Create an Approle</h3>
<p>Create an approle named "<strong><em>Kube-role</em></strong>". The secret id for cert-manager should not be expired to use this Approle for authentication, hence do not set a TTL, or set it to 0.</p>
<pre class="codehilite"><code>% vault auth enable approle of token ttl 5 minutes

% vault write auth/approle/role/kube-role \
    token_ttl=5m \
    token_max_ttl=10m</code></pre>


<h3 id="associate-a-policy-with-the-approle">Associate a policy with the Approle</h3>
<p>Perform the following steps to associate a policy with an Approle.</p>
<ol>
<li>
<p>Create a file <code>pki_int.hcl</code> with the following configuration to allow the signing endpoints of the intermediate CA.</p>
<pre class="codehilite"><code>path &quot;${PKI_INT}/sign/*&quot; {
      capabilities = [&quot;create&quot;,&quot;update&quot;]
    }</code></pre>


</li>
<li>
<p>Add the file to a new policy called <code>kube_allow_sign</code> using the following command.</p>
<pre class="codehilite"><code>vault policy write kube-allow-sign pki_int.hcl</code></pre>


</li>
<li>
<p>Update this policy to the approle using the following command.</p>
<pre class="codehilite"><code>vault write auth/approle/role/kube-role policies=kube-allow-sign</code></pre>


</li>
</ol>
<p>The <code>kube-role</code> approle allows you to sign the CSR with intermediate CA.</p>
<h3 id="generate-the-role-id-and-secret-id">Generate the Role id and Secret id</h3>
<p>Role id and Secret id is used by cert-manager to authenticate with Vault.</p>
<p>Generate role id and Secret id and encode the <code>secret_id</code> with Base64. Perform the following:</p>
<pre class="codehilite"><code>% vault read auth/approle/role/kube-role/role-id
role_id     db02de05-fa39-4855-059b-67221c5c2f63

% vault write -f auth/approle/role/kube-role/secret-id
secret_id               6a174c20-f6de-a53c-74d2-6018fcceff64
secret_id_accessor      c454f7e5-996e-7230-6074-6ef26b7bcf86

# encode secret_id with base64
% echo 6a174c20-f6de-a53c-74d2-6018fcceff64 | Base64
NmExNzRjMjAtZjZkZS1hNTNjLTc0ZDItNjAxOGZjY2VmZjY0Cg==</code></pre>


<h2 id="configure-issuing-certificates-in-kubernetes">Configure issuing certificates in Kubernetes</h2>
<p>After you have configured the Vault as intermediate CA, and the Approle authentication method for cert-manager to access the Vault. You need to configure the certificate for the ingress.</p>
<h3 id="create-a-secret-with-approle-secret-id">Create a secret with Approle secret-id</h3>
<p>Perform the following to create a secret with Approle secret id.</p>
<ol>
<li>
<p>Create a secret file called <code>secretid.yaml</code> with following configuration.</p>
<pre class="codehilite"><code>apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: cert-manager-vault-approle
  namespace: cert-manager
data:
  secretId: &quot;NmExNzRjMjAtZjZkZS1hNTNjLTc0ZDItNjAxOGZjY2VmZjY0Cg==&quot;</code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>data.secretId</code> is the base64 encoded Secret Id generated in <a href="#generate-the-role-id-and-secret-id">Generate the Role id and Secret id</a>. If you're using an Issuer resource in the next step, Secret must be in same namespace as the <code>Issuer</code>. For <code>ClusterIssuer</code>, secret must be in <code>cert-manager</code> namespace.</p>
</div>
</li>
<li>
<p>Deploy the secret file (<code>secretid.yaml</code>) using the following command.</p>
<pre class="codehilite"><code>% kubectl create -f secretid.yaml</code></pre>


</li>
</ol>
<h3 id="deploy-the-vault-cluster-issuer">Deploy the Vault cluster issuer</h3>
<p>Certmanager supports two different CRDs for configuration, an <code>Issuer</code>, which is scoped to a single namespace, and a <code>ClusterIssuer</code>, which is cluster-wide. For the workflow, you need to use <code>ClusterIssuer</code>.</p>
<p>Perform the following steps to deploy the Vault cluster issuer.</p>
<ol>
<li>
<p>Create a file called <code>issuer-vault.yaml</code> with the following configuration.</p>
<pre class="codehilite"><code>apiVersion: certmanager.k8s.io/v1alpha1
kind: ClusterIssuer
metadata:
  name: vault-issuer
spec:
  vault:
    path: ${PKI_INT}/sign/kube-ingress
    server: https://vault_ip
    caBundle: &lt;base64 encoded caBundle PEM file&gt;
    auth:
      appRole:
        path: approle
        roleId: &quot;db02de05-fa39-4855-059b-67221c5c2f63&quot;
        secretRef:
          name: cert-manager-vault-approle
          key: secretId</code></pre>


<p>Replace <code>PKI_INT</code> with appropriate path of the intermediate CA. <code>SecretRef</code> is the kubernetes secret name created in the previous step. Replace <code>roleId</code> with the <code>role_id</code> retrieved from Vault.
An optional base64 encoded caBundle in PEM format can be provided to validate the TLS connection to the Vault Server. When caBundle is set it replaces the CA bundle inside the container running the cert-manager. This parameter has no effect if the connection used is in plain HTTP.</p>
</li>
<li>
<p>Deploy the file (<code>issuer-vault.yaml</code>) using the following command.</p>
<pre class="codehilite"><code>% kubectl create -f issuer-vault.yaml</code></pre>


</li>
<li>
<p>Using the following command verify if the Vault cluster issuer is successfully authenticated with the Vault.</p>
<pre class="codehilite"><code>% kubectl describe clusterIssuer vault-issuer  | tail -n 7
  Conditions:
    Last Transition Time:  2019-02-26T06:18:40Z
    Message:               Vault verified
    Reason:                VaultVerified
    Status:                True
    Type:                  Ready
Events:                    &lt;none&gt;</code></pre>


</li>
</ol>
<h3 id="create-a-certificate-crd-object-for-the-certificate">Create a "certificate" CRD object for the certificate</h3>
<p>Once the issuer is successfully registered , you need to get the certificate for the ingress domain <code>kuard.example.com</code>.</p>
<p>You need to create a "certificate" resource with the commonName and dnsNames. For more information, see <a href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html">cert-manager documentation</a>. You can specify multiple dnsNames which will be used for SAN field in the certificate.</p>
<p>To create a "certificate" CRD object for the certificate, perform the following:</p>
<ol>
<li>
<p>Create a file called <code>certificate.yaml</code> with the following configuration.</p>
<pre class="codehilite"><code>apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: kuard-example-tls
  namespace: default
spec:
  secretName: kuard-example-tls
  issuerRef:
    kind: ClusterIssuer
    name: vault-issuer
  commonName: kuard.example.com
  duration: 720h
  #Renew before 7 days of expiry
  renewBefore: 168h
  commonName: kuard.example.com
  dnsNames:
  - www.kuard.example.com</code></pre>


<p>The certificate will have CN=<code>kuard.example.com</code> and SAN=<code>Kuard.example.com,www.kuard.example.com</code>.
<code>spec.secretName</code> is the name of the secret where the certificate is stored after the certificate is issued successfully.</p>
</li>
<li>
<p>Deploy the file (<code>certificate.yaml</code>) on the Kubernetes cluster using the following command.</p>
<pre class="codehilite"><code>kubectl create -f certificate.yaml
certificate.certmanager.k8s.io/kuard-example-tls created</code></pre>


</li>
</ol>
<h3 id="verify-if-the-certificate-is-issued">Verify if the certificate is issued</h3>
<p>You can watch the progress of the certificate as it is issued using the following command:</p>
<pre class="codehilite"><code>% kubectl describe certificates kuard-example-tls  | grep -A5 Events
Events:
  Type    Reason      Age   From          Message
  ----    ------      ----  ----          -------
  Normal  CertIssued  48s   cert-manager  Certificate issued successfully</code></pre>


<div class="admonition info">
<p class="admonition-title">Important</p>
<p>You may encounter some errors due to Vault policies. If you encounter any such errors, return to vault and fix it.</p>
</div>
<p>After successful signing, a <code>kubernetes.io/tls</code> secret is created with the <code>secretName</code> specified in the <code>Certificate</code> resource.</p>
<pre class="codehilite"><code>% kubectl get secret kuard-example-tls
NAME                TYPE                DATA   AGE
kuard-exmaple-tls   kubernetes.io/tls   3      4m20s</code></pre>


<h2 id="modify-the-ingress-to-use-the-generated-secret">Modify the ingress to use the generated secret</h2>
<p>Perform the following steps to modify the ingress to use the generated secret.</p>
<ol>
<li>
<p>Edit the original ingress and add a <code>spec.tls</code> section specifying the secret <code>kuard-example-tls</code> as follows.</p>
<pre class="codehilite"><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kuard
  annotations:
    kubernetes.io/ingress.class: &quot;citrix&quot;
spec:
  tls:
  - hosts:
    - kuard.example.com
    secretName: kuard-example-tls
  rules:
  - host: kuard.example.com
    http:
      paths:
      - backend:
          serviceName: kuard
          servicePort: 80</code></pre>


</li>
<li>
<p>Deploy the ingress using the following command.</p>
<pre class="codehilite"><code>% kubectl apply -f ingress.yml
ingress.extensions/kuard created

% kubectl get ingress kuard
NAME    HOSTS               ADDRESS   PORTS     AGE
kuard   kuard.example.com             80, 443   12s</code></pre>


</li>
<li>
<p>Log on to CPX and verify if the Certificate is bound to the SSL virtual server.</p>
<pre class="codehilite"><code>kubectl exec -it cpx-ingress-668bf6695f-4fwh8 bash
cli_script.sh 'shsslvs'
exec: shsslvs
1) Vserver Name: k8s-10.244.3.148:443:ssl
  DH: DISABLED
  DH Private-Key Exponent Size Limit: DISABLED  Ephemeral RSA: ENABLED      Refresh Count: 0
  Session Reuse: ENABLED        Timeout: 120 seconds
  Cipher Redirect: DISABLED
  SSLv2 Redirect: DISABLED
  ClearText Port: 0
  Client Auth: DISABLED
  SSL Redirect: DISABLED
  Non FIPS Ciphers: DISABLED
  SNI: ENABLED
  OCSP Stapling: DISABLED
  HSTS: DISABLED
  HSTS IncludeSubDomains: NO
  HSTS Max-Age: 0
  SSLv2: DISABLED  SSLv3: ENABLED  TLSv1.0: ENABLED  TLSv1.1: ENABLED  TLSv1.2: ENABLED  TLSv1.3: DISABLED
  Push Encryption Trigger: Always
  Send Close-Notify: YES
  Strict Sig-Digest Check: DISABLED
  Zero RTT Early Data: DISABLED
  DHE Key Exchange With PSK: NO
  Tickets Per Authentication Context: 1
Done

root@cpx-ingress-668bf6695f-4fwh8:/# cli_script.sh 'shsslvs k8s-10.244.3.148:443:ssl'
exec: shsslvs k8s-10.244.3.148:443:ssl

  Advanced SSL configuration for VServer k8s-10.244.3.148:443:ssl:
  DH: DISABLED
  DH Private-Key Exponent Size Limit: DISABLED  Ephemeral RSA: ENABLED      Refresh Count: 0
  Session Reuse: ENABLED        Timeout: 120 seconds
  Cipher Redirect: DISABLED
  SSLv2 Redirect: DISABLED
  ClearText Port: 0
  Client Auth: DISABLED
  SSL Redirect: DISABLED
  Non FIPS Ciphers: DISABLED
  SNI: ENABLED
  OCSP Stapling: DISABLED
  HSTS: DISABLED
  HSTS IncludeSubDomains: NO
  HSTS Max-Age: 0
  SSLv2: DISABLED  SSLv3: ENABLED  TLSv1.0: ENABLED  TLSv1.1: ENABLED  TLSv1.2: ENABLED  TLSv1.3: DISABLED
  Push Encryption Trigger: Always
  Send Close-Notify: YES
  Strict Sig-Digest Check: DISABLED
  Zero RTT Early Data: DISABLED
  DHE Key Exchange With PSK: NO
  Tickets Per Authentication Context: 1
, P_256, P_384, P_224, P_5216)  CertKey Name: k8s-LMO3O3U6KC6WXKCBJAQY6K6X6JO   Server Certificate for SNI

7)  Cipher Name: DEFAULT
  Description: Default cipher list with encryption strength &gt;= 128bit
Done

root@cpx-ingress-668bf6695f-4fwh8:/# cli_script.sh 'sh certkey k8s-LMO3O3U6KC6WXKCBJAQY6K6X6JO'
exec: sh certkey k8s-LMO3O3U6KC6WXKCBJAQY6K6X6JO
  Name: k8s-LMO3O3U6KC6WXKCBJAQY6K6X6JO     Status: Valid,   Days to expiration:0
  Version: 3
  Serial Number: 524C1D9306F784A2F5277C05C2A120D5258D9A2F
  Signature Algorithm: sha256WithRSAEncryption
  Issuer:  CN=example.com CA intermediate
  Validity
    Not Before: Feb 26 06:48:39 2019 GMT
    Not After : Feb 27 06:49:09 2019 GMT
  Certificate Type: &quot;Client Certificate&quot;    &quot;Server Certificate&quot;
  Subject:  CN=kuard.example.com
  Public Key Algorithm: rsaEncryption
  Public Key size: 2048
  Ocsp Response Status: NONE
  2)     URI:http://127.0.0.1:8200/v1/pki_int/crl
  3)    VServer name: k8s-10.244.3.148:443:ssl  Server Certificate for SNI
Done</code></pre>


</li>
</ol>
<p>The HTTPS webserver is UP with the vault signed certificate. Cert-manager automatically renews the certificate as specified in the 'RenewBefore" parameter in the Certificate, before expiry of the certificate.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The vault signing of the certificate fails if the expiry of a certificate is beyond the expiry of the root CA or intermediate CA. You should ensure that the CA certificates are renewed in advance before the expiry.</p>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../acme/" title="Deploy HTTPs web applications on K8s with CIC and Let’s Encrypt using cert-manager" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deploy HTTPs web applications on K8s with CIC and Let’s Encrypt using cert-manager
              </span>
            </div>
          </a>
        
        
          <a href="../../metrics/promotheus-grafana/" title="Integrate with Promotheus and Grafana" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Integrate with Promotheus and Grafana
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 1999-2019 Citrix Systems, Inc. All rights reserved.  | <a href="http://www.citrix.com/about/legal/legal-notice.html">Terms of Use | <a href="#" onclick="event.preventDefault(); window.evidon.notice.showConsentTool();">Cookie Preferences</a></a></p>
          </div>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://www.youtube.com/channel/UCiOupk9QF6jdk3EDKTHDykA" class="md-footer-social__link fa fa-youtube"></a>
    
      <a href="https://github.com/citrix" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://twitter.com/citrixdeveloper" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/citrix/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
<script type="text/javascript">
(function (id) {
    function append(scriptid, url, async) {
        var d = document, sn = 'script', f = d.getElementsByTagName(sn)[0];
        if (!f) f = d.head;
        var s = d.createElement(sn);
        s.async = true;
        s.id = scriptid;
        s.src = url;
        f.parentNode.insertBefore(s, f);
    }

    function getRootDomain() {
        var parts = window.location.hostname.split('.');
        if (parts.length === 2) rootDomain = parts[0];
        else if (parts.length > 2) {
          // see if the next to last value is a common tld
          var part = parts[parts.length - 2];
          if (part === 'com' || part === 'co') {
            rootDomain = parts[parts.length - 3]; // go back one more
          }
          else {
            rootDomain = part;
          }
        }

      return rootDomain;
    }

    window.evidon = {};
    window.evidon.id = id;
    var cdn = '//c.evidon.com/', rootDomain = getRootDomain(), noticecdn = cdn + 'sitenotice/';
    append('evidon-notice', noticecdn + 'evidon-sitenotice-tag.js', false);
    append('evidon-location', cdn + 'geo/country.js', true);
    append('evidon-themes', noticecdn + id + '/snthemes.js', true);
    if (rootDomain) append('evidon-settings', noticecdn + id + '/' + rootDomain + '/settings.js', true);

    window.evidon.priorConsentCallback = function () {
        // add the tags which need to wait for prior consent
        // here.  This should be all your advertising tags and
        // probably most of your social and tracking tags.
    }
})(3010);
</script>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.43ad2ac2.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>